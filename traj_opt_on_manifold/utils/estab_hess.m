function hess = estab_hess(u,Jrinv,Jr)
    u1 = u(1);
    u2 = u(2);
    u3 = u(3);
    
    r=(u1^2 + u2^2 + u3^2)^(1/2);
    
    if r < 1e-6
        hess{1} = zeros(3,3);
        hess{2} = zeros(3,3);
        hess{3} = zeros(3,3);
        return;
    end
    
    r2 = u1^2 + u2^2 + u3^2;
    sin_r2 = sin(r);
    cos_r2 = cos(r);
    sin_r = sin(r/2);
    cos_r = cos(r/2);

    dd1 = [ ...
        [ (u1*(sin_r2 - r))/(4*sin_r^2*r), (u2*(sin_r2 - r))/(4*sin_r^2*r), (u3*(sin_r2 - r))/(4*sin_r^2*r)]; ...
        [    0,    0,    0]; ...
        [    0,    0,    0]; ...
        [    0,    0,    0]; ...
        [ (u1*(sin_r2 - r))/(4*sin_r^2*r), (u2*(sin_r2 - r))/(4*sin_r^2*r), (u3*(sin_r2 - r))/(4*sin_r^2*r)]; ...
        [    0,    0,    0]; ...
        [    0,    0,    0]; ...
        [    0,    0,    0]; ...
        [ (u1*(sin_r2 - r))/(4*sin_r^2*r), (u2*(sin_r2 - r))/(4*sin_r^2*r), (u3*(sin_r2 - r))/(4*sin_r^2*r)]];
 
    dd2 = [ ...
            [     (2*u1^3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (2*u1*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1^3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)),                        -(u1^2*u2*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2),                        -(u1^2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2)]; ...
            [ (2*u1^2*u2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u2*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1^2*u2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)), (2*u1*u2^2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u1*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1*u2^2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)),                       -(u1*u2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2)]; ...
            [ (2*u1^2*u3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u3*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1^2*u3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)),                       -(u1*u2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2), (2*u1*u3^2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u1*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1*u3^2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2))]; ...
            [ (2*u1^2*u2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u2*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1^2*u2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)), (2*u1*u2^2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u1*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1*u2^2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)),                       -(u1*u2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2)]; ...
            [                        -(u1*u2^2*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2),     (2*u2^3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (2*u2*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u2^3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)),                        -(u2^2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2)]; ...
            [                       -(u1*u2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2), (2*u2^2*u3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u3*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u2^2*u3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)), (2*u2*u3^2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u2*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u2*u3^2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2))]; ...
            [ (2*u1^2*u3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u3*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1^2*u3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)),                       -(u1*u2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2), (2*u1*u3^2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u1*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u1*u3^2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2))]; ...
            [                       -(u1*u2*u3*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2), (2*u2^2*u3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u3*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u2^2*u3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2)), (2*u2*u3^2*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (u2*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u2*u3^2*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2))]; ...
            [                        -(u1*u3^2*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2),                        -(u2*u3^2*(4*cos_r2 + sin_r2*r + r2 - 4))/(2*(cos_r2 - 1)*(r2)^2),     (2*u3^3*((cos_r*r)/(2*sin_r) - 1))/(r2)^2 - (2*u3*((cos_r*r)/(2*sin_r) - 1))/(r2) - (u3^3*(sin_r2 - r))/(4*sin_r^2*(r2)^(3/2))]];


    dd3 = [ ...
            [    0,    0,    0]; ...
            [    0,    0,  1/2]; ...
            [    0, -1/2,    0]; ...
            [    0,    0, -1/2]; ...
            [    0,    0,    0]; ...
            [  1/2,    0,    0]; ...
            [    0,  1/2,    0]; ...
            [ -1/2,    0,    0]; ...
            [    0,    0,    0]];
        
   
        
    ddJrinv = dd1+dd2+dd3;
    
    ddJr = [ ...
            [                                                                                                                                                                -(2*u1^3*r - 2*u1*(r2)^(3/2) + u1^3*cos_r2*r + 3*u1*u2^2*sin_r2 + 3*u1*u3^2*sin_r2 - u1*cos_r2*(r2)^(3/2))/(r2)^(5/2),                                                                                                                                                                              -(u2*sin_r2*(r2) - 3*u1^2*u2*sin_r2 - u2*cos_r2*(r2)^(3/2) + 2*u1^2*u2*r + u1^2*u2*cos_r2*r)/(r2)^(5/2),                                                                                                                                                                              -(u3*sin_r2*(r2) - 3*u1^2*u3*sin_r2 - u3*cos_r2*(r2)^(3/2) + 2*u1^2*u3*r + u1^2*u3*cos_r2*r)/(r2)^(5/2)]; ...
            [ (u1^2*u2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u2*(sin_r2 - r))/(r2)^(3/2) - (u1*u3*sin_r2)/(r2)^(3/2) - (2*u1*u3*(cos_r2 - 1))/(r2)^2 + (2*u1^2*u2*(sin_r2 - r))/(r2)^(5/2), (u1*u2^2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u1*(sin_r2 - r))/(r2)^(3/2) - (u2*u3*sin_r2)/(r2)^(3/2) - (2*u2*u3*(cos_r2 - 1))/(r2)^2 + (2*u1*u2^2*(sin_r2 - r))/(r2)^(5/2),                                     (cos_r2 - 1)/(r2) - (u3^2*sin_r2)/(r2)^(3/2) - (2*u3^2*(cos_r2 - 1))/(r2)^2 + (u1*u2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) + (2*u1*u2*u3*(sin_r2 - r))/(r2)^(5/2)]; ...
            [ (u1^2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u3*(sin_r2 - r))/(r2)^(3/2) + (u1*u2*sin_r2)/(r2)^(3/2) + (2*u1*u2*(cos_r2 - 1))/(r2)^2 + (2*u1^2*u3*(sin_r2 - r))/(r2)^(5/2),                                     (u2^2*sin_r2)/(r2)^(3/2) - (cos_r2 - 1)/(r2) + (2*u2^2*(cos_r2 - 1))/(r2)^2 + (u1*u2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) + (2*u1*u2*u3*(sin_r2 - r))/(r2)^(5/2), (u1*u3^2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u1*(sin_r2 - r))/(r2)^(3/2) + (u2*u3*sin_r2)/(r2)^(3/2) + (2*u2*u3*(cos_r2 - 1))/(r2)^2 + (2*u1*u3^2*(sin_r2 - r))/(r2)^(5/2)]; ...
            [ (u1^2*u2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u2*(sin_r2 - r))/(r2)^(3/2) + (u1*u3*sin_r2)/(r2)^(3/2) + (2*u1*u3*(cos_r2 - 1))/(r2)^2 + (2*u1^2*u2*(sin_r2 - r))/(r2)^(5/2), (u1*u2^2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u1*(sin_r2 - r))/(r2)^(3/2) + (u2*u3*sin_r2)/(r2)^(3/2) + (2*u2*u3*(cos_r2 - 1))/(r2)^2 + (2*u1*u2^2*(sin_r2 - r))/(r2)^(5/2),                                     (u3^2*sin_r2)/(r2)^(3/2) - (cos_r2 - 1)/(r2) + (2*u3^2*(cos_r2 - 1))/(r2)^2 + (u1*u2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) + (2*u1*u2*u3*(sin_r2 - r))/(r2)^(5/2)]; ...
            [                                                                                                                                                                              -(u1*sin_r2*(r2) - 3*u1*u2^2*sin_r2 - u1*cos_r2*(r2)^(3/2) + 2*u1*u2^2*r + u1*u2^2*cos_r2*r)/(r2)^(5/2),                                                                                                                                                                -(2*u2^3*r - 2*u2*(r2)^(3/2) + u2^3*cos_r2*r + 3*u1^2*u2*sin_r2 + 3*u2*u3^2*sin_r2 - u2*cos_r2*(r2)^(3/2))/(r2)^(5/2),                                                                                                                                                                              -(u3*sin_r2*(r2) - 3*u2^2*u3*sin_r2 - u3*cos_r2*(r2)^(3/2) + 2*u2^2*u3*r + u2^2*u3*cos_r2*r)/(r2)^(5/2)]; ...
            [                                     (cos_r2 - 1)/(r2) - (u1^2*sin_r2)/(r2)^(3/2) - (2*u1^2*(cos_r2 - 1))/(r2)^2 + (u1*u2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) + (2*u1*u2*u3*(sin_r2 - r))/(r2)^(5/2), (u2^2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u3*(sin_r2 - r))/(r2)^(3/2) - (u1*u2*sin_r2)/(r2)^(3/2) - (2*u1*u2*(cos_r2 - 1))/(r2)^2 + (2*u2^2*u3*(sin_r2 - r))/(r2)^(5/2), (u2*u3^2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u2*(sin_r2 - r))/(r2)^(3/2) - (u1*u3*sin_r2)/(r2)^(3/2) - (2*u1*u3*(cos_r2 - 1))/(r2)^2 + (2*u2*u3^2*(sin_r2 - r))/(r2)^(5/2)]; ...
            [ (u1^2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u3*(sin_r2 - r))/(r2)^(3/2) - (u1*u2*sin_r2)/(r2)^(3/2) - (2*u1*u2*(cos_r2 - 1))/(r2)^2 + (2*u1^2*u3*(sin_r2 - r))/(r2)^(5/2),                                     (cos_r2 - 1)/(r2) - (u2^2*sin_r2)/(r2)^(3/2) - (2*u2^2*(cos_r2 - 1))/(r2)^2 + (u1*u2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) + (2*u1*u2*u3*(sin_r2 - r))/(r2)^(5/2), (u1*u3^2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u1*(sin_r2 - r))/(r2)^(3/2) - (u2*u3*sin_r2)/(r2)^(3/2) - (2*u2*u3*(cos_r2 - 1))/(r2)^2 + (2*u1*u3^2*(sin_r2 - r))/(r2)^(5/2)]; ...
            [                                     (u1^2*sin_r2)/(r2)^(3/2) - (cos_r2 - 1)/(r2) + (2*u1^2*(cos_r2 - 1))/(r2)^2 + (u1*u2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) + (2*u1*u2*u3*(sin_r2 - r))/(r2)^(5/2), (u2^2*u3*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u3*(sin_r2 - r))/(r2)^(3/2) + (u1*u2*sin_r2)/(r2)^(3/2) + (2*u1*u2*(cos_r2 - 1))/(r2)^2 + (2*u2^2*u3*(sin_r2 - r))/(r2)^(5/2), (u2*u3^2*(sin_r2 - cos_r2*r))/(r2)^(5/2) - (u2*(sin_r2 - r))/(r2)^(3/2) + (u1*u3*sin_r2)/(r2)^(3/2) + (2*u1*u3*(cos_r2 - 1))/(r2)^2 + (2*u2*u3^2*(sin_r2 - r))/(r2)^(5/2)]; ...
            [                                                                                                                                                                              -(u1*sin_r2*(r2) - 3*u1*u3^2*sin_r2 - u1*cos_r2*(r2)^(3/2) + 2*u1*u3^2*r + u1*u3^2*cos_r2*r)/(r2)^(5/2),                                                                                                                                                                              -(u2*sin_r2*(r2) - 3*u2*u3^2*sin_r2 - u2*cos_r2*(r2)^(3/2) + 2*u2*u3^2*r + u2*u3^2*cos_r2*r)/(r2)^(5/2),                                                                                                                                                                -(2*u3^3*r - 2*u3*(r2)^(3/2) + u3^3*cos_r2*r + 3*u1^2*u3*sin_r2 + 3*u2^2*u3*sin_r2 - u3*cos_r2*(r2)^(3/2))/(r2)^(5/2)]];

    
    ddtotal = kron(Jr',eye(3))*ddJrinv + kron(eye(3),Jrinv)*ddJr;
    
    hess{1} = ddtotal([1,4,7],:);
    hess{2} = ddtotal([2,5,8],:);
    hess{3} = ddtotal([3,6,9],:);
end